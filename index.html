<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ficha - CP</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
  --bg:#000000;
  --panel:#0b0b0b;
  --accent:#b58f12;
  --muted:#ffffff;
  --text:#f2f2f2;
  --danger:#d14;
  --info: #4169E1;
  --critfail: #b10000;
  --fail: #ffffff;
  --success:#56ff56;
  --great: #794dff;
  --extreme: #ffbf00;
}
    #hpMeter { background: red !important; transition: width 0.5s ease-in-out;}
    #sanMeter { background: #8A2BE2 !important; transition: width 0.5s ease-in-out;}
    #adrMeter { background: #FFFF00 !important; }

    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:1300px;margin:24px auto;padding:0px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    h1{margin:0 0 8px;color:var(--accent)}
    h2{margin-top:0;color:var(--accent);font-size:16px}
    .row.top { display:flex; flex-wrap: wrap; gap:16px; margin-bottom:16px; }
    .row.bottom { display:flex; gap:16px; align-items:flex-start; margin-bottom:16px; }
    .col{flex:1}
    .panel{background:var(--panel);padding:12px;border-radius:8px;border:1px solid rgba(181,143,18,0.08)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);font-size:15px;}
    textarea{min-height:40px;resize:vertical;}
    .small{max-width:160px}
    .attributes{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .attr{padding:10px;background:rgba(255,255,255,0.02);border-radius:6px;text-align:center}
    .attr h3{margin:0;font-size:14px;color:var(--accent)}
    .attr .val{font-size:20px;margin-top:6px}
    button{background:var(--accent);border:none;color:#0b0b0b;padding:8px 10px;border-radius:6px;cursor:pointer; font-weight: bold;}
    button.ghost{background:transparent;border:1px solid rgba(181,143,18,0.12);color:var(--text)}
    .bars{display:flex;gap:12px}
    
    .bar{flex:1;padding:8px;border-radius:6px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);} 
    .meter{height:18px;background:var(--muted);border-radius:8px;overflow:hidden;margin-top:8px}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffd24d);width:0%}
    .controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
   }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;font-size:11px}
    th{color:var(--accent);text-align:center}
    .skill-val {
    width: 70px;
    text-align: center;
    font-size: 12px;
    padding: 0px;
    }

    #body-svg path {
        transition: fill 0.3s ease;
    }
    
.roll-icon {
    background: url(https://crisordemparanormal.com/assets/d20-icon-TtjmS7-Z.png) no-repeat center center;
    background-size: contain;
    width: 28px; 
    height: 28px;
    display: inline-block;
    opacity: 0.8;
    transition: transform 0.2s ease, opacity 0.2s ease;
}

#rollModal {

.roll-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}

.skills-button-td button {
    background: none; 
    border: none; 
    padding: 0; 
    cursor: pointer;
    position: relative;
    z-index: 101;
    }

pointer-events: none;

}
  #rollModalContent {

  .roll-result{min-width:130px}
    .footer{margin-top:16px;font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    @media(max-width:900px){.attributes{grid-template-columns:repeat(4,1fr)}.row{flex-direction:column}}
    pointer-events: none;
}


    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }

    .attr-input { width: 70px; text-align: center; font-size: 18px; background: transparent; color: var(--text); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 6px; padding: 6px; }
    .adrenalina-container { display: flex; flex-direction: column; width: 100%; }
    .adrenalina-bar { display: flex; justify-content: space-between; gap: 4px; width: 100%; height: 20px; margin-top: 8px; }
    .adrenalina-bar .segment{ flex:1; border:2px solid #FFD700; border-radius:8px; height:100%; background:transparent; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); transition: background .3s, border-color .3s; }
    .adrenalina-bar .segment.filled{ background:#FFD700; border-color:#e6be00; }
    .adrenalina-controls { display: flex; align-items: center; gap: 8px; margin-top: 19px; }
    
    #body-svg path {
        transition: fill 0.3s ease;
    }

    /* --- ESTILOS DAS ABAS --- */
    .tab-nav {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--panel);
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--muted);
      border-radius: 6px 6px 0 0;
      font-size: 16px;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab-btn.active {
      background: var(--panel);
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }
    .tab-content {
      display: none; 
    }
    .tab-content.active {
      display: block; 
    }

    /* --- ESTILOS PARA ABA INFO --- */
    #tabInfo .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    #tabInfo .info-grid .full-width {
      grid-column: span 2;
    }

    /* --- ESTILOS PARA O INDEX --- */
    .index-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        text-align: center;
        background: var(--panel);
        border-radius: 8px;
    }
    .sheet-list {
        list-style: none;
        padding: 0;
        margin-top: 20px;
        text-align: left;
    }
    .sheet-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
	height: 85px;
    }
    .sheet-name-link {
        color: var(--text);
        text-decoration: none;
        flex-grow: 1;
        cursor: pointer;
        padding-right: 10px;
    }
    .sheet-delete-btn {
        background: var(--danger);
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
	height: 37px;
	width: 76px;
    }
    .sheet-delete-btn:hover { background: #c0392b; }

    .sheet-avatar {
        width: 70px;
        height: 70px;
        object-fit: cover;
        margin-right: 10px;
        border: 1px solid var(--border-color);
        background-color: #333;
    }

    #sheetList li {
	display: flex;
	align-items: center; /* Centraliza verticalmente */
	padding: 10px;
    }

/* Estilo da foto dentro da ficha */
#charAvatar {
    width: 100px;  /* Tamanho da foto */
    height: 100px;
    object-fit: cover;  /* Garante que a imagem preencha sem esticar */
    border: 3px solid var(--accent-color, #d4af37); /* Borda dourada ou da cor do tema */
    cursor: pointer; /* M√£ozinha indicando clique */
    transition: transform 0.2s, filter 0.2s;
    background-color: #222;
}

#charAvatar:hover {
    transform: scale(1.05); /* Cresce um pouco ao passar o mouse */
    filter: brightness(1.2); /* Fica mais brilhante */
}

/* Responsivo para celular */
@media (max-width: 600px) {
    #charAvatar {
        width: 80px;
        height: 80px;
    }
}

    /* IN√çCIO: ESTILOS DE RESPONSIVIDADE (768px) */
 @media(max-width: 768px) {
      #tabInfo .info-grid {
        grid-template-columns: 1fr;
      }
      #tabInfo .info-grid .full-width {
        grid-column: span 1;
      }
      
      .row.bottom .col.panel[style*="min-width:540px"] { 
          min-width: unset !important;
          flex: 1 1 100% !important;
          max-width: 100% !important;
      }
      .row.bottom > .col:first-child > div[style*="display:flex;"] {
          flex-direction: column-reverse !important; 
          gap: 12px;
      }
      #skillsTable, #habilidadesTable {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
      }
      #skillsTable tr td:first-child {
           min-width: 120px;
      }
    }

    /* IN√çCIO: ESTILOS DE RESPONSIVIDADE ADICIONAIS (600px - Mobile) */
    @media (max-width: 600px) {

.row.top,
.row.bottom {
    display: flex !important;           
    flex-direction: column !important;  
    width: 100% !important;             
}

.row.top > .col,
.row.bottom > .col {
    flex: 1 1 100% !important;
    max-width: 100% !important;
    min-width: unset !important;
    width: 100% !important; 
    margin-bottom: 15px; 
}

        .container {
            margin: 0;
            padding: 12px;
            border-radius: 0;
            box-shadow: none;
        }
        
        h1 {
            font-size: 24px;
        }

        .row.top > .col,
        .row.bottom > .col {
            flex: 1 1 100% !important;
            max-width: 100% !important;
            min-width: unset !important;
        }

        .attributes {
            grid-template-columns: repeat(3, 1fr) !important; 
            gap: 8px;
        }

        .col.panel div:first-child > div[style*="display:flex; gap:24px;"] {
            flex-direction: row !important; 
            flex-wrap: wrap; 
            gap: 8px !important; 
            justify-content: space-between; 
        }

        #inventoryTable {
            width: 100% !important; 
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        #inventoryTable input[type=text], #inventoryTable input[type=number] {
            padding: 6px 4px;
            font-size: 13px;
        }
        
        #body-diagram {
             padding-left: 0px !important;
             justify-content: center !important;
             height: 250px !important; 
             margin-top: 10px;
        }

        .controls {
             flex-wrap: wrap;
        }
        .bars {
            flex-direction: column;
            gap: 10px;
        }
        .bar {
            padding: 10px;
        }
        .bar input {
            width: 60px !important;
        }
        .adrenalina-controls {
            margin-top: 10px;
            justify-content: center;
        }
        
        .row.top > .col:first-child > .row.top {
             flex-direction: column;
             gap: 10px;
        }
        .row.top > .col:first-child > .row.top > div {
            width: 100% !important;
        }
        
        .col.panel div:first-child > div[style*="display:flex;"]:not([style*="gap:24px;"]) {
            flex-direction: column !important;
            align-items: flex-start;
            gap: 8px;
        }
    }

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

  </style>
</head>
<body>

  <div id="indexPage" class="index-container" style="display:none;">
      <h1>Selecione sua Ficha</h1>
      <button id="createSheetBtn" style="margin-bottom: 20px; padding: 10px 20px;">Criar Nova Ficha</button>
      <h2>Fichas Salvas:</h2>
      <ul id="sheetList" class="sheet-list">
          </ul>
  </div>

  <div id="fichaContent" style="display:none;">
    <div class="container">

      <button id="backToIndexBtn" class="ghost" style="margin-bottom: 16px; padding: 6px 10px;">&larr; Voltar ao Menu</button>

      <h1>Ficha de Personagem</h1>

<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
          <div class="avatar-container">
              <img id="charAvatar" 
                   src="https://i.imgur.com/huZjuCz.png" 
                   title="Clique para mudar a foto"
                   style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #d4af37; cursor: pointer;">
          </div>
      </div>

    <div class="tab-nav">
      <button class="tab-btn active" data-tab="tabStatus">Status</button>
      <button class="tab-btn" data-tab="tabInventario">Inventario</button>
      <button class="tab-btn" data-tab="tabHabilidades">Habilidades</button>
      <button class="tab-btn" data-tab="tabInfo">Info</button>
    </div>

    <div id="tabStatus" class="tab-content active">
      <div class="row top">
          <div class="col panel">

            <h2>Detalhes Pessoais</h2>
            <div class="row top">
              <div class="col">
                <label>Nome do Personagem</label>
                <input id="nomePersonagem" type="text" />
              </div>
              <div class="col">
                <label>Nome do Jogador</label>
                <input id="nomeJogador" type="text" />
              </div>
              <div style="width:120px">
                <label>Idade</label>
                <input id="idade" type="number" min="0" />
              </div>
              <div style="width:140px">
                <label>G√™nero</label>
                <input id="genero" type="text" />
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Ocupa√ß√£o</label>
              <input id="ocupacao" type="text" />
            </div>
            <div class="row bottom" style="margin-top:10px">
              <div class="col">
                <label>Resid√™ncia</label>
                <input id="residencia" type="text" />
              </div>
              <div class="col">
                <label>Local de Nascimento</label>
                <input id="nascimento" type="text" />
              </div>
            </div>
          </div>
          <div class="col panel">
            <h2>Atributos</h2>
            <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Atribua os valores nos campos abaixo.</div>
            <div class="attributes" id="attributes">
              </div>
          </div>
        </div>

        <div class="row bottom">
          <div class="col" style="flex: 0 0 805px; max-width:900px; display:flex; flex-direction:column; gap:12px;">
            <div class="panel">
              <h2>Status</h2>
               <div class="bars">
                <div class="bar">
                  <div class="label">Vida</div>
                  <div class="meter"><i id="hpMeter"></i></div>
                  <div class="controls">
                    <div>Atual: <input id="hpCurrent" type="number" style="width:80px;"/></div>
                    <div>M√°x: <input id="hpMax" type="number" style="width:60px;" title="HP Base (Manual)"/> <span id="hpTotalDisplay" style="font-size:12px; color:var(--success); font-weight:bold; margin-left:4px;"></span></div>
                    <button id="hpMinus">-</button>
                    <button id="hpPlus">+</button>
                  </div>
                </div>

                <div class="bar">
                  <div class="label">Sanidade</div>
                  <div class="meter"><i id="sanMeter"></i></div>
                  <div class="controls">
                    <div>Atual: <input id="sanCurrent" type="number" min="0" style="width:80px;"/></div>
                    <div>M√°x: <input id="sanMax" type="number" min="0" style="width:80px;"/></div>
                    <button id="sanMinus">-</button>
                    <button id="sanPlus">+</button>
                  </div>
                </div>

            <div class="bar" id="adrenalinaBarContainer">
                  <div class="label">Adrenalina</div>
                  <div class="adrenalina-container">
                    <div class="adrenalina-bar">
                       <div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div>
                   </div>
                   <div class="adrenalina-controls">
                       <button id="adrMinus">-</button>
                       <span id="adrValue">0</span>
                       <button id="adrPlus">+</button>
                     </div>
                   </div>
                  <input id="adrCurrent" type="hidden" value="0"/><input id="adrMax" type="hidden" value="4"/>
                </div>
              </div>

              <div style="display:flex; gap:16px; margin-top:12px;">
                <div id="body-diagram" style="height:270px; flex:1; display:none; justify-content:flex-start; padding-left: 42px;">
                   <svg id="body-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1450 2800" style="height:100%; width:auto;">
                    <g fill="#888">
                      <path id="head" d="M850.54 3.71c-286.42,0.77 -170.63,475.91 -2.26,470.04 176.41,-6.13 269.57,-470.77 2.26,-470.04z"/>
                      <path id="torso" d="M739.07 505.38c-14.3,-5.86 -14.17,-1.08 -22.8,6.11 -15.37,12.78 -50.91,27.97 -65.58,32.58 -45.68,14.26 -110.44,26.5 -155.23,48.88 -5.94,2.97 -18.13,8.97 -9.54,17.13 40.07,37.66 67.33,89.93 88.23,147.71 52.43,144.97 55.43,331.34 51.44,457.9 -2.86,98.03 -41.38,188.76 -41.38,285.77 0,1.97 1.59,3.56 3.54,3.56l519.2 0.01c0.24,-0.25 3.63,-0.13 3.68,-3.64 0.16,-11.18 0.01,-20.43 -1.51,-31.56 -7.09,-51.95 -21.79,-120.55 -31.66,-182.39 -20.77,-130.25 -3.43,-331.37 14.56,-458.58 5.34,-37.77 26.93,-78.57 43.08,-110.18 20.4,-39.76 63.76,-88.08 74.61,-109.76 2.82,-5.04 1.3,-10.22 -3.17,-13.52 -9.77,-7.15 -52.24,-21 -64.99,-24.69 -48.15,-13.91 -103.71,-21.83 -144.73,-48.91 -8.69,-5.74 -16.67,-11.18 -21.48,-12.52 -9.33,-2.59 -17.47,-1.53 -24.48,3.37 -42.97,28.75 -164.23,12.28 -211.79,-7.27z"/>
                      <path id="left-arm" d="M1136.68 831.22c-42.92,168.46 54.68,382.71 85.95,549.57 2.66,14.47 2.83,26.64 0.54,41.13 -4.83,25.14 -12.58,46.86 -18.15,72.59 -5.26,24.22 -12.97,46.02 -10.96,76.14 0.82,12.18 3.51,22.72 11.29,21.08 11.91,-2.52 24.75,-58.23 25.6,-68.42 0.36,-4.54 5.65,-3.61 9.63,-3.61 1.91,0 3.47,1.55 3.47,3.47 0,6.93 -7.88,47.37 -9.79,56.31 -3.23,15.23 -32.99,73.54 -36.7,82.34 -9.46,22.91 3.09,34.25 18.4,16.72 20.56,-23.54 26.72,-40.67 43.68,-65.47 14.98,-22.01 26.99,-44.79 31.36,-71.91 5.61,-34.37 9.5,-83.92 9.81,-118.24 0,-97.27 -8.45,-189.01 -14.85,-287.63 -5.75,-88.61 -25.67,-168.82 -29.78,-266.74 -2.81,-66.88 -13.15,-184.51 -12.99,-193.43 0.19,-10.8 -7.55,-16.29 -16.55,-7.18 -67.55,67.93 -69.39,79.77 -89.96,163.28z"/>
                      <path id="right-arm" d="M470.76 1385.48c31.99,-170.66 131.82,-389.81 87.92,-562.12 -21.04,-85.42 -22.92,-97.53 -92.02,-167.02 -9.21,-9.31 -17.13,-3.7 -16.93,7.35 0.16,9.12 -10.41,129.44 -13.29,197.86 -4.2,100.15 -24.58,182.19 -30.46,272.83 -6.54,100.87 -15.18,194.71 -15.18,294.2 0.32,35.1 4.29,85.79 10.03,120.94 4.46,27.74 16.75,51.04 32.08,73.55 17.34,25.37 23.65,42.9 44.68,66.97 15.66,17.93 28.49,6.34 18.81,-17.1 -3.79,-9 -34.24,-68.64 -37.53,-84.22 -1.96,-9.15 -10.02,-50.51 -10.02,-57.6 0,-1.96 1.59,-3.55 3.55,-3.55 4.07,0 9.48,-0.94 9.85,3.7 0.87,10.42 14,67.4 26.19,69.98 7.95,1.67 10.71,-9.11 11.54,-21.56 2.06,-30.81 -5.83,-53.11 -11.2,-77.88 -5.71,-26.32 -13.63,-48.54 -18.58,-74.25 -2.34,-14.83 -2.16,-27.27 0.56,-42.08z"/>
                      <path id="left-leg" d="M872.67 1544.43c0,9.41 30.97,314.66 41.97,384.88 1.31,8.36 11.27,50.77 16.45,76.8 7.92,39.81 -7,141.5 -10.02,207.52 -3.5,76.52 10.68,174.09 12.35,261.94 0.89,46.72 -6.58,86.72 -6.25,137.04 0.14,23.6 -6.78,34.09 -7.05,58.91 -0.57,41.88 62.01,34.99 90.24,34.99 10.62,-0.15 50.54,-2.78 53.76,-14.17 4.91,-17.53 -22.37,-35.86 -31.86,-54.65 -34.23,-67.94 -16.28,-148.64 -3.6,-220.04 0,-0.06 0.02,-0.12 0.04,-0.18 16.48,-57.06 36.57,-128.8 46,-186.53 14.91,-91.12 -1.25,-183.87 -1.93,-275.18 -1.43,-78.78 23.99,-190.27 25.65,-277.13 0.32,-47.63 0,-94.14 0,-140.74 0.01,-2.82 -6.3,-1.89 -8.01,-1.71 -83.9,8.95 -131.68,10.6 -216.38,6.95 -0.65,-0.06 -1.36,0.59 -1.36,1.3z"/>
                      <path id="right-leg" d="M820.47 1537.12c-85.58,3.69 -133.86,2.01 -218.63,-7.02 -1.73,-0.19 -8.1,-1.13 -8.09,1.72 0,47.09 -0.32,94.08 0,142.21 1.69,88.76 27.36,200.41 25.91,280.01 -0.68,92.26 -17.01,185.97 -1.95,278.03 9.53,58.34 29.83,130.83 46.48,188.48 0.03,0.06 0.04,0.12 0.04,0.18 12.81,72.14 30.95,153.68 -3.63,222.32 -9.59,18.99 -37.16,37.51 -32.19,55.22 3.24,11.52 43.58,14.18 54.32,14.33 28.52,0 91.75,6.95 91.18,-35.36 -0.29,-25.08 -7.27,-35.68 -7.13,-59.52 0.34,-50.85 -7.22,-91.26 -6.32,-138.47 1.69,-88.76 16.02,-187.34 12.48,-264.66 -3.05,-66.71 -18.13,-169.45 -10.12,-209.68 5.23,-26.3 15.29,-69.15 16.62,-77.6 11.11,-70.95 42.41,-379.37 42.41,-388.87 0,-0.73 -0.72,-1.38 -1.38,-1.32z"/>
                    </g>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <div class="col panel" style="flex: 1; min-width: 440px;margin-bottom: 15px;">
            <h2>Per√≠cias</h2>
            <div style="font-size:13px;color:var(--muted)">Distribua os pontos de per√≠cia abaixo.</div>
            <div style="margin-top:8px;max-height:430px;overflow:auto">
              <table id="skillsTable"><thead><tr><th>Per√≠cia</th><th>Valor Base</th><th>Valor Atual</th><th style="width: 40px;"></th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
    </div>

    <div id="tabHabilidades" class="tab-content">
      <div class="panel">
        <h2>Habilidades</h2>
        <table id="habilidadesTable">
            <thead>
                <tr>
                    <th style="width: 25%; height: 40px;">Nome da Habilidade</th>
                    <th style="width: 55%; height: 40px;">Efeito</th>
                    <th style="width: 15%; height: 40px;">Custo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button id="addHabilidadeBtn" style="margin-top: 12px;">Adicionar Habilidade</button>

      </div>
    </div>

<div id="tabInventario" class="tab-content">
  <div class="panel">
    
    <div class="col panel" style="flex:0 0 340px; min-width:540px;"> 
        
        <h2>Invent√°rio</h2>
        
        <div style="display:flex;gap:12px;align-items:center;">
          <div>
            
            <div style="display:flex; gap:24px; align-items:center; margin-bottom:8px;">
              <div>
                <label><strong>Peso:</strong></label>
                <span id="pesoAtual">0</span> /
                <input type="number" id="pesoMax" style="width:35px; text-align: center; background:transparent; border:none;" min="0" value="11" readonly>
              </div>
              <div>
                <label><strong>Espa√ßo:</strong></label>
                <span id="espacoAtual">0</span> /
                <input type="number" id="espacoMax" style="width:35px; text-align: center;" min="0" value="4">
              </div>
              <div>
                <label><strong>Mochila:</strong></label>
                <input type="number" id="Mochila" style="width:35px; text-align: center;" min="0" value="0">
              </div>
            </div>
            
            <table id="inventoryTable" style="width:125%;margin-top:8px;">
              <thead><tr><th>Item</th><th>Peso</th><th>Espa√ßos</th><th></th></tr></thead>
              <tbody>
                  </tbody>
            </table>
            
            <button id="addItemBtn" style="margin-top:8px;">Adicionar Item</button>
          </div>
        </div>
        
    </div> </div>
</div>

    <div id="tabInfo" class="tab-content">
      <div class="panel">
        <h2>Antecedentes</h2>
        <div class="info-grid">
            <div>
                <label>Descri√ß√£o Pessoal</label>
                <textarea id="infoDescricao"></textarea>
            </div>
            <div>
                <label>Caracter√≠sticas</label>
                <textarea id="infoCaracteristicas"></textarea>
            </div>
            <div>
                <label>Ideologia/Cren√ßas</label>
                <textarea id="infoIdeologia"></textarea>
            </div>
            <div>
                <label>Ferimentos & Cicatrizes</label>
                <textarea id="infoFerimentos"></textarea>
            </div>
            <div>
                <label>Pessoas Significativas</label>
                <textarea id="infoPessoas"></textarea>
            </div>
            <div>
                <label>Locais Importantes</label>
                <textarea id="infoLocais"></textarea>
            </div>
            <div>
                <label>Fobias & Manias</label>
                <textarea id="infoFobias"></textarea>
            </div>
            <div>
                <label>Objetos Importantes</label>
                <textarea id="infoObjetos"></textarea>
            </div>
        </div>
      </div>
      <div class="panel" style="margin-top: 16px;">
        <h2>Dinheiro e Recursos</h2>
        <div class="info-grid">
            <div>
                <label>Dinheiro</label>
                <input type="text" id="infoDinheiro" />
            </div>
            <div>
                <label>Patrim√¥nio</label>
                <input type="text" id="infoPatrimonio" />
            </div>
        </div>
	</div>
      <div class="panel" style="margin-top: 16px;">
        <h2>Configura√ß√µes</h2>
        <div class="info-grid">
	<div class="password-controls" style="margin: 10px 0; display: flex; gap: 10px;">
    <button id="btnSetPassword" class="btn" style="font-size: 12px;">üîê Definir Senha</button>
    <button id="btnRemovePassword" class="btn" style="background: #441111; font-size: 12px;">üîì Remover 		Senha</button>
	</div>
      </div>
    </div>

<div id="rollModal" style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0); pointer-events: none;">
    
    <div id="rollModalContent" style="background-color: var(--panel); padding: 1px; border: 1px solid var(--accent); border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: auto; position: absolute; right: 40px; bottom: 30px; width: 320px; max-width: 320px;">
        
        <span id="closeModalBtn" style="color: var(--accent); float: right; font-size: 28px; font-weight: bold; margin-right: 10px; cursor: pointer;">&times;</span>

	<p id="rollSkillName" style="font-size: 17px; font-weight: bold; margin-left: 10px; margin-top: 8px; color: var(--accent);"></p>
        
        <p id="rollValue" style="font-size: 50px; font-weight: bold; text-align: center; margin: 10px 0;"></p>
        
        <p id="rollResult" style="font-size: 30px; font-weight: bold; text-align: center; margin-top: -15px;"></p> 

        <p id="rollDetails" style="font-size: 18px; font-weight: bold; color: var(--muted); margin-left: 5px; margin-top: -15px;"></p>
       
    </div>
</div>
</div>

  </div>
</div>


  <script>
	const SUPABASE_URL = 'https://ndqnzqbbugidewnqlxmp.supabase.co';
	const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kcW56cWJidWdpZGV3bnFseG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDU0MTUsImV4cCI6MjA4NDA4MTQxNX0.9l5p47Eu3POuegTracQUHOBpmdnJssjb2l0dCgdNwLw';
	const _supabase = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;
	const MASTER_PASS = "pontosdeadrenalina"; // <--- Escolha sua senha secreta de Mestre
	const SHEET_PREFIX = 'cp_sheet_';
	const SHEET_LIST_KEY = 'cp_sheets_list';
	let currentSheetId = null;
	let state = { /* ... seu estado inicial ... */ };

    /* ---------- DATA (SEM MUDAN√áAS) ---------- */
    const ATTRS = ['FOR','CON','TAM','DES','APA','INT','MEN','COH','SOR'];
    const SKILLS = [['Acrobacia',4],['Antropologia',1],['Armas (Pistolas)',4],['Armas (Rifles/Espingardas)',5],['Armas (Arcos/Bestas)',3],['Arqueologia',1],['Arremessar',4],['Arte e Of√≠cio',1],['Avalia√ß√£o',1],['Cavalgar',1],['Charme',3],['Chaveiro',1],['Ci√™ncia (Biologia)',1],['Ci√™ncia (Forense)',1],['Ci√™ncia (Farm√°cia)',1],['Ci√™ncia (Qu√≠mica)',1],['Conhecimento',1],['Consertos El√©tricos',2],['Consertos Mec√¢nicos',2],['Contabilidade',1],['Demoli√ß√µes',1],['Direito',1],['Dirigir',4],['Disfarce',1],['Eletr√¥nica',1],['Encontrar',5],['Escutar',4],['Esquivar',0],['Furtividade',4],['Hipnose',1],['Hist√≥ria',1],['Intimida√ß√£o',3],['L√°bia',1],['Leitura Labial',1],['L√≠ngua (Nativa)',0],['L√≠ngua (Outra)',1],['Lutar (Brigar)',5],['Medicina',1],['Mergulho',1],['Mundo Natural',2],['Nata√ß√£o',2],['Navega√ß√£o',2],['Ocultismo',2],['Operar Maquin√°rio',1],['Persuas√£o',2],['Pilotar (Aeronave)',1],['Pilotar (Barco)',1],['Prestidigita√ß√£o',2],['Primeiros Socorros',6],['Psican√°lise',1],['Psicologia',2],['Rastrear',2],['Sobreviv√™ncia',2],['Treinar Animais',1],['Usar Bibliotecas',4],['Usar Computadores',4]];
    const THRESHOLDS = {1:{N:20,B:null,E:null},2:{N:19,B:20,E:null},3:{N:18,B:20,E:null},4:{N:17,B:19,E:null},5:{N:16,B:19,E:20},6:{N:15,B:18,E:20},7:{N:14,B:18,E:20},8:{N:13,B:17,E:20},9:{N:12,B:17,E:20},10:{N:11,B:16,E:19},11:{N:10,B:16,E:19},12:{N:9,B:15,E:19},13:{N:8,B:15,E:19},14:{N:7,B:14,E:19},15:{N:6,B:14,E:18},16:{N:5,B:13,E:18},17:{N:4,B:13,E:18},18:{N:3,B:12,E:18},19:{N:2,B:12,E:18},20:{N:1,B:11,E:17}};

 /* ---------- UTILITIES (MODIFICADO PARA M√öLTIPLAS FICHAS) ---------- */
    function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
    function rollDice(n,sides){let out=[];for(let i=0;i<n;i++)out.push(randInt(1,sides));return out}
    function escapeId(s){return s.replace(/[^a-z0-9]/gi,'_')}
    
    async function saveState() {
    if (!currentSheetId) return;

    const { error } = await _supabase
        .from('fichas')
        .update({ dados: state })
        .eq('nome_id', currentSheetId);

    if (error) {
        console.error("Erro ao salvar:", error.message);
    } else {
        console.log("Altera√ß√£o salva com sucesso!");
    }
}
    
    function loadState(id){
        try{
            const data = JSON.parse(localStorage.getItem(SHEET_PREFIX + id))||{};
            
            // INICIALIZA√á√ÉO DE TODOS OS CAMPOS
            if(!data.attrs) data.attrs = {FOR:10,CON:10,TAM:10,DES:10,APA:10,INT:10,MEN:10,COH:10,SOR:10};
            if(!data.skills) data.skills = {};
            if(!data.details) data.details = {};
            if(!data.info) data.info = {};
            
            // HP: Inicializa Base se n√£o existir
            if(data.hpBase===undefined) data.hpBase = 0;
            // O hpMax agora ser√° calculado (Total), mas precisamos de um placeholder
            if(data.hpMax===undefined) data.hpMax = 10; 
            if(data.hpCurrent===undefined) data.hpCurrent = data.hpMax;
            
            if(data.sanMax===undefined) data.sanMax = data.attrs.MEN * 5;
            if(data.sanCurrent===undefined) data.sanCurrent = data.sanMax;
            if(data.adrCurrent===undefined) data.adrCurrent = 0;
            if(data.mochila===undefined) data.mochila = 0;
            if (data.isAdrenalineVisible === undefined) data.isAdrenalineVisible = false;
            if (data.isBodyDiagramVisible === undefined) data.isBodyDiagramVisible = false;
            
            // Inicializa valores das per√≠cias
            SKILLS.forEach(([name,base])=>{ 
                 if(data.skills[name]===undefined) data.skills[name]=base; 
            });
            
            return data;
        }catch(e){
            return {};
        }
    }

    /* ---------- SCRIPT PRINCIPAL ---------- */
    document.addEventListener("DOMContentLoaded", () => {
        
      const indexPageEl = document.getElementById('indexPage');
      const fichaContentEl = document.getElementById('fichaContent');
      const sheetListEl = document.getElementById('sheetList');
      const createSheetBtn = document.getElementById('createSheetBtn');
      const backToIndexBtn = document.getElementById('backToIndexBtn');
      const nomePersonagemInput = document.getElementById('nomePersonagem');

      // --- Vari√°veis Globais de Estado ---
      let inventory = [];
      let habilidades = [];
      let bodyColors = {};

      function showPage(pageId) {
          indexPageEl.style.display = pageId === 'index' ? 'block' : 'none';
          fichaContentEl.style.display = pageId === 'ficha' ? 'block' : 'none';
      }
      
      // ----------------------------------------------------
      // L√ìGICA DE GERENCIAMENTO DE FICHAS (INDEX)
      // ----------------------------------------------------

      function getSheetList() {
          try {
              return JSON.parse(localStorage.getItem(SHEET_LIST_KEY)) || [];
          } catch (e) {
              return [];
          }
      }

      function saveSheetList(list) {
          localStorage.setItem(SHEET_LIST_KEY, JSON.stringify(list));
      }
      
async function renderIndex() {
    sheetListEl.innerHTML = '<li style="justify-content:center; color: var(--muted);">Buscando fichas na nuvem...</li>';
    
    const { data: fichasNuvem, error } = await _supabase
        .from('fichas')
        .select('nome_id, dados');

    sheetListEl.innerHTML = '';
    
    if (error || !fichasNuvem || fichasNuvem.length === 0) {
        sheetListEl.innerHTML = '<li style="justify-content:center; color: var(--muted);">Nenhuma ficha encontrada na nuvem.</li>';
    } else {
        fichasNuvem.forEach(item => {
            const sheetData = item.dados;
            const li = document.createElement('li');
            
	    const img = document.createElement('img');
            img.className = 'sheet-avatar';
            
            const defaultImage = 'https://i.imgur.com/huZjuCz.png';
            img.src = sheetData.details?.imagem || defaultImage;
            
            // Se a imagem der erro ao carregar (link quebrado), volta para o padr√£o
            img.onerror = () => { img.src = defaultImage; };
            
            // Torna a imagem clic√°vel tamb√©m para abrir a ficha
            img.style.cursor = 'pointer';
            img.addEventListener('click', (e) => {
                e.preventDefault();
                loadSheet(item.nome_id);
            });

            const nameLink = document.createElement('a');
            nameLink.className = 'sheet-name-link';
            nameLink.style.cursor = 'pointer';
            nameLink.textContent = sheetData.details?.nomePersonagem || 'Personagem Sem Nome';
            
            nameLink.addEventListener('click', (e) => {
                e.preventDefault();
                loadSheet(item.nome_id);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'sheet-delete-btn';
            deleteBtn.textContent = 'Deletar';
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if(confirm("Deseja apagar esta ficha da nuvem permanentemente?")) {
                    await _supabase.from('fichas').delete().eq('nome_id', item.nome_id);
                    renderIndex();
                }
            });

	    li.appendChild(img);
            li.appendChild(nameLink);
            li.appendChild(deleteBtn);
            sheetListEl.appendChild(li);
        }); // Fechamento correto do forEach
    } // Fechamento correto do else
    showPage('index');
}

      async function createNewSheet() {
    // 1. Gera um ID √∫nico e um nome padr√£o sem perguntar nada
    const id = 'sheet-' + Date.now();
    const nomePadrao = ""; 

    // 2. Estado inicial da ficha (Limpo)
    const initialState = {
    details: { 
        nomePersonagem: "", 
        jogador: "",
        ocupacao: "",
        idade: "",
        infoDescricao: "" // Adicionado para evitar o erro!
    },
    attrs: { FOR:10, CON:10, TAM:10, DES:10, APA:10, INT:10, MEN:10, EDU:10, SOR:10 },
    hpMax: 10, hpCurrent: 10, hpBase: 0,
    sanMax: 50, sanCurrent: 50, sanBase: 0,
    inventory: [],
    skills: [],
    notes: "",
    password: null 
};

    // 3. Envia para o Supabase
    const { error } = await _supabase
        .from('fichas')
        .insert({ 
            nome_id: id, 
            dados: initialState 
        });

    if (error) {
        console.error("Erro ao criar no banco:", error.message);
        alert("Erro de conex√£o com o servidor.");
        return;
    }

    // 4. Abre a ficha imediatamente
    loadSheet(id);
}

      function deleteSheet(id, name) {
          if (confirm(`Vai deletar a ficha de "${name}"? N√£o da pra restaurar, seu com√©dia.`)) {
              localStorage.removeItem(SHEET_PREFIX + id);
              localStorage.removeItem(SHEET_PREFIX + id + '_inventory');
              localStorage.removeItem(SHEET_PREFIX + id + '_habilidades');
              localStorage.removeItem(SHEET_PREFIX + id + '_bodyColors');
              
              let list = getSheetList();
              list = list.filter(sheet => sheet.id !== id);
              saveSheetList(list);
              
              if (currentSheetId === id) {
                  currentSheetId = null;
              }
              renderIndex();
          }
      }

      function saveInventory() { 
          if(currentSheetId) localStorage.setItem(SHEET_PREFIX + currentSheetId + '_inventory', JSON.stringify(inventory)); 
      }
      function saveHabilidades() { 
          if(currentSheetId) localStorage.setItem(SHEET_PREFIX + currentSheetId + '_habilidades', JSON.stringify(habilidades)); 
      }
      function saveBodyState() { 
          if(currentSheetId) localStorage.setItem(SHEET_PREFIX + currentSheetId + '_bodyColors', JSON.stringify(bodyColors)); 
      }

      // ----------------------------------------------------
      // L√ìGICA DE CARREGAMENTO (FICHA)
      // ----------------------------------------------------

// L√≥gica para Definir/Remover Senha
document.getElementById('btnSetPassword').onclick = () => {
    const p = prompt("Defina uma senha para esta ficha:");
    if(p !== null) { state.password = p; saveState(); alert("Senha salva!"); }
};

document.getElementById('btnRemovePassword').onclick = () => {
    if(confirm("Remover a prote√ß√£o por senha?")) { state.password = null; saveState(); alert("Senha removida!"); }
};

async function loadSheet(id) {
    console.log("Tentando carregar a ficha:", id);
    
    // 1. Busca no Supabase
    const { data, error } = await _supabase
        .from('fichas')
        .select('*')
        .eq('nome_id', id)
        .maybeSingle();

    if (error) {
        console.error("Erro na busca do Supabase:", error.message);
        alert("Erro ao conectar com o banco de dados.");
        return;
    }

    if (!data) {
        console.error("Ficha n√£o encontrada no banco de dados para o ID:", id);
        alert("Essa ficha n√£o existe no servidor.");
        return;
    }

    const avatarImg = document.getElementById('charAvatar');
    // Verifica se existe imagem salva no state, sen√£o usa a padr√£o
    if (state.details && state.details.imagem) {
   	 avatarImg.src = state.details.imagem;
    } else {
 	   avatarImg.src = 'https://i.imgur.com/huZjuCz.png'; // Imagem padr√£o
    }

	// Se a imagem quebrar (link antigo), volta pra padr√£o
	avatarImg.onerror = () => { 
  	  avatarImg.src = 'https://i.imgur.com/huZjuCz.png'; 
    };

const avatarImgElement = document.getElementById('charAvatar');
    if (avatarImgElement) {
        avatarImgElement.addEventListener('click', () => {
        // Abre uma caixinha perguntando o link
        const novaUrl = prompt("Cole o link da imagem do seu personagem (Discord, Imgur, 	        etc):", state.details?.imagem || "");
        
            if (novaUrl) {
                // Atualiza na tela na hora
                avatarImgElement.src = novaUrl;
            
                // Garante que o objeto details existe
                if (!state.details) state.details = {};
            
                // Salva no estado
                state.details.imagem = novaUrl;
                saveState(); // Manda pro banco
            }
        });
    }

function updateAvatar() {
    const avatarImg = document.getElementById('charAvatar');
    if (avatarImg) {
        // Busca a imagem do estado, se n√£o tiver usa a padr√£o
        const savedImg = state.details?.imagem || 'https://i.imgur.com/huZjuCz.png';
        avatarImg.src = savedImg;

        // Se o link estiver quebrado, n√£o deixa a imagem sumir
        avatarImg.onerror = () => {
            avatarImg.src = 'https://i.imgur.com/huZjuCz.png';
        };

        // Adiciona o clique para mudar a foto (apenas se ainda n√£o tiver o evento)
        avatarImg.onclick = () => {
            const novaUrl = prompt("Cole o link da imagem (URL):", state.details?.imagem || "");
            if (novaUrl !== null) {
                avatarImg.src = novaUrl;
                if (!state.details) state.details = {};
                state.details.imagem = novaUrl;
                saveState(); // Salva no Supabase
            }
        };
    }
}

    // 2. Extrai os dados
    const tempState = data.dados;
    console.log("Dados recebidos com sucesso:", tempState);

    // 3. Verifica senha (simplificado para n√£o travar)
    if (tempState.password) {
        const tentativa = prompt("Ficha protegida por senha:");
        if (tentativa !== tempState.password && tentativa !== MASTER_PASS) {
            alert("Senha incorreta!");
            return;
        }
    }

    // 4. ATUALIZA TUDO
    state = tempState;
    currentSheetId = id;
    
    // Salva o √∫ltimo ID no navegador
    localStorage.setItem('cp_last_sheet_id', id);

    // Chama as fun√ß√µes de atualizar a tela
    try {
        syncAll();        // Preenche os campos
        showPage('ficha'); // MUDA A TELA (Importante!)
        enableRealtime(id); // Ativa o tempo real
        console.log("Ficha aberta com sucesso!");
    } catch (err) {
        console.error("Erro ao renderizar a ficha:", err);
        alert("Erro visual: Verifique se as fun√ß√µes syncAll ou showPage existem.");
    }
}

      function updateSheetName() {
          if (!nomePersonagemInput || !currentSheetId) return;
          
          const newName = nomePersonagemInput.value || 'Personagem Sem Nome';
          const list = getSheetList();
          const sheet = list.find(s => s.id === currentSheetId);
          
          if (sheet) {
              sheet.name = newName;
              saveSheetList(list);
          }
      }

      function renderAttributes() {
        const container = document.getElementById('attributes');
        container.innerHTML = '';
        ATTRS.forEach(a => {
          const div = document.createElement('div');
          div.className = 'attr';
          div.innerHTML = `<h3>${a}</h3>`;
          const input = document.createElement('input');
          input.type = 'number';
          input.id = 'attr_' + a;
          input.min = 0;
          input.max = 20;
          input.value = state.attrs[a] ?? 0;
          input.classList.add('attr-input');
          input.addEventListener('change', e => {
            let val = e.target.value.replace(/[^0-9]/g, '');
            if (val === '') val = 0;
            let n = Number(val);
            if (n < 0) n = 0;
            state.attrs[a] = n;
            e.target.value = n;
            recalcHPandSAN();
            saveState();
          });
          div.appendChild(input);
          container.appendChild(div);
        });
        recalcHPandSAN();
      }

      // --- ALTERA√á√ÉO AQUI: L√ìGICA DE HP ---
function recalcHPandSAN(){
    // C√°lculo HP: Valor Digitado (Base) + ((CON + TAM) / 2 - 10)
    const con = Number(state.attrs.CON) || 0;
    const tam = Number(state.attrs.TAM) || 0;
    const hpBonus = Math.floor((con + tam) / 2);
    
    // Define 10 como base inicial se for novo
    if(state.hpBase === undefined) state.hpBase = 0;
    state.hpMax = state.hpBase + hpBonus;

    // C√°lculo SAN: Valor Digitado (Base) + (MEN * 5)
    // 50 √© o valor inicial sugerido
    const men = Number(state.attrs.MEN) || 0;
    const sanBonus = men * 5;
    
    if(state.sanBase === undefined) state.sanBase = 0;
    state.sanMax = state.sanBase + sanBonus;
    
    // Atualiza os inputs com o valor total (Base + B√¥nus)
    document.getElementById('hpMax').value = state.hpMax;
    document.getElementById('sanMax').value = state.sanMax;
    document.getElementById('hpCurrent').value = state.hpCurrent;
    document.getElementById('sanCurrent').value = state.sanCurrent;
    
    // Peso M√°ximo baseado na FOR
    const pesoMaxEl = document.getElementById('pesoMax');
    if (pesoMaxEl) {
        const forca = Number(state.attrs.FOR) || 0;
        const pesoMaxCalculado = 11 + Math.floor(forca / 2);
        pesoMaxEl.value = pesoMaxCalculado;
    }
    
    updateMeters();
    saveState();
}

      function updateMeters(){
          // Usa state.hpMax (que agora √© o Total) para a porcentagem
          const hpPct = state.hpMax? Math.max(0,Math.min(100,Math.round(state.hpCurrent/state.hpMax*100))):0;
          const sanPct = state.sanMax? Math.max(0,Math.min(100,Math.round(state.sanCurrent/state.sanMax*100))):0;
          document.getElementById('hpMeter').style.width = hpPct + '%';
          document.getElementById('sanMeter').style.width = sanPct + '%';
          
          const segmentos = document.querySelectorAll('.adrenalina-bar .segment');
          const count = Math.max(0, Math.min(4, Math.round(Number(state.adrCurrent) || 0)));
          segmentos.forEach((seg, i) => seg.classList.toggle('filled', i < count));
          document.getElementById('adrValue').textContent = count;
          
          saveState();
      }

      function renderSkills(){
        const tbody = document.querySelector('#skillsTable tbody');
	tbody.innerHTML='';
        SKILLS.forEach(([name,base])=>{
          const tr = document.createElement('tr');
          const curVal = state.skills[name] ?? base;
          tr.innerHTML = `<td>${name}</td><td class="skill-base">${base}</td><td><input class="skill-val" data-name="${name}" type="number" min="1" max="20" value="${curVal}"/></td><td><button data-roll="${name}" style="background:none; border:none; padding:0; cursor:pointer;"><span class="roll-icon"></span></button></td>`;
          tbody.appendChild(tr);
        });
	document.querySelectorAll('.skill-val').forEach(inp => {
           inp.addEventListener('input', e => {
            const skillName = e.target.dataset.name;
            let value = Number(e.target.value);
            value = Math.max(1, Math.min(20, value));
            state.skills[skillName] = value;
            saveState(); 
        });
    });

    document.querySelectorAll('button[data-roll]').forEach(btn => {
        btn.addEventListener('click', e => {
            const skillName = e.currentTarget.dataset.roll;
            rollSkill(skillName); 
        });
    });
}

      
      function renderBodyDiagram() {
          const bodyDiagramContainer = document.getElementById('body-svg');
          if (!bodyDiagramContainer) return;
          
          const parts = bodyDiagramContainer.querySelectorAll("path");
          
          parts.forEach(part => {
              const savedColor = bodyColors[part.id] || "#888";
              part.setAttribute("fill", savedColor);
              
              part.removeEventListener("click", handleBodyPartClick);
              part.addEventListener("click", handleBodyPartClick);
              part.style.cursor = "pointer";
          });
      }

      function handleBodyPartClick(e) {
          const part = e.currentTarget;
          const currentFill = part.getAttribute("fill");
          let next;
          switch (true) {
            case currentFill === "#888" || currentFill.includes("136, 136, 136"): next = "rgba(255, 255, 0, 0.75)"; break; // amarelo
            case currentFill.includes("255, 255, 0"): next = "rgba(255, 0, 0, 0.75)"; break; // vermelho
            case currentFill.includes("255, 0, 0"): next = "#888"; break; // cinza
            default: next = "#888"; break;
          }
          part.setAttribute("fill", next);
          bodyColors[part.id] = next; 
          saveBodyState(); 
      }

      function renderDetailsAndInfo() {
          const detailIds = ['nomePersonagem','nomeJogador','idade','genero','ocupacao','residencia','nascimento'];
          detailIds.forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                  el.value = state.details[id] ?? '';
              }
          });
          
          const infoIds = ['infoDescricao','infoCaracteristicas','infoIdeologia','infoFerimentos','infoPessoas','infoLocais','infoFobias','infoObjetos', 'infoDinheiro', 'infoPatrimonio'];
			infoIds.forEach(id => {
   		 	const el = document.getElementById(id);
   			 if (el) {
       		 el.value = (state.info && state.info[id]) ?? '';
    }
});
      }

      const inventoryTable = document.getElementById("inventoryTable").querySelector("tbody");
      const pesoAtualEl = document.getElementById("pesoAtual");
      const espacoAtualEl = document.getElementById("espacoAtual");
      const pesoMaxEl = document.getElementById("pesoMax");
      const espacoMaxEl = document.getElementById("espacoMax");
      const addItemBtn = document.getElementById("addItemBtn");
      const mochilaInput = document.getElementById('Mochila');
      
      function atualizarTotais() {
        const totalPeso = inventory.reduce((sum, item) => sum + (Number(item.peso)||0), 0);
        const totalEspaco = inventory.reduce((sum, item) => sum + (Number(item.espaco)||0), 0);
        pesoAtualEl.textContent = totalPeso;
        espacoAtualEl.textContent = totalEspaco;
        
        const pesoMaxValor = Number(pesoMaxEl.value) || 0;
        pesoAtualEl.style.color = (totalPeso > pesoMaxValor && pesoMaxValor > 0) ? 'red' : '';
        saveInventory();
      }

      function criarLinha(item = {nome:'', peso:0, espaco:0}) {
        const tr = document.createElement("tr");
        const createCell = (el) => { const td = document.createElement("td"); td.appendChild(el); return td; };
        
        const nomeInput = document.createElement("input"); nomeInput.type = "text"; nomeInput.value = item.nome;
        const pesoInput = document.createElement("input"); pesoInput.type = "number"; pesoInput.min = 0; pesoInput.step = 0.1; pesoInput.value = item.peso; pesoInput.style.width = "60px";
        const espacoInput = document.createElement("input"); espacoInput.type = "number"; espacoInput.min = 0; espacoInput.value = item.espaco; espacoInput.style.width = "60px";
        const removeBtn = document.createElement("button"); removeBtn.textContent = "‚ùå"; removeBtn.style.cursor = "pointer";

        [nomeInput, pesoInput, espacoInput].forEach(inp => {
          inp.addEventListener("input", () => {
            item.nome = nomeInput.value;
            item.peso = Number(pesoInput.value) || 0;
            item.espaco = Number(espacoInput.value) || 0;
            atualizarTotais();
          });
        });
        removeBtn.addEventListener("click", () => {
          inventory = inventory.filter(i => i !== item);
          tr.remove();
          atualizarTotais();
        });
        tr.appendChild(createCell(nomeInput)); tr.appendChild(createCell(pesoInput)); tr.appendChild(createCell(espacoInput)); tr.appendChild(createCell(removeBtn));
        inventoryTable.appendChild(tr);
      }

      function renderInventory() {
        inventoryTable.innerHTML = "";
        inventory.forEach(item => criarLinha(item));
        
        if (mochilaInput) {
            mochilaInput.value = state.mochila ?? 0; 
        }
        
        atualizarTotais();
        atualizarEspacoMax(); 
      }

      addItemBtn.addEventListener("click", () => {
        const newItem = {nome:'', peso:0, espaco:0};
        inventory.push(newItem);
        criarLinha(newItem);
        atualizarTotais();
      });

      function atualizarEspacoMax() {
        const mochila = parseInt(mochilaInput.value) || 0;
        espacoMaxEl.value = mochila + 4;
        
        state.mochila = mochila;
        saveState(); 
      }
      mochilaInput.addEventListener('input', atualizarEspacoMax);
      pesoMaxEl.addEventListener("input", atualizarTotais);
      
      const habilidadesTable = document.getElementById("habilidadesTable").querySelector("tbody");
      const addHabilidadeBtn = document.getElementById("addHabilidadeBtn");

      function criarLinhaHabilidade(habilidade = { nome: '', efeito: '', custo: '' }) {
          const tr = document.createElement("tr");
          const createCell = (el) => { const td = document.createElement("td"); td.appendChild(el); return td; };

          const nomeInput = document.createElement("textarea"); nomeInput.value = habilidade.nome; nomeInput.rows = 1;
          const efeitoInput = document.createElement("textarea"); efeitoInput.value = habilidade.efeito; efeitoInput.rows = 1;
          const custoInput = document.createElement("textarea"); custoInput.value = habilidade.custo; custoInput.rows = 1;
          
          const removeBtn = document.createElement("button"); removeBtn.textContent = "‚ùå"; removeBtn.style.cursor = "pointer";

          [nomeInput, efeitoInput, custoInput].forEach(textarea => {
            textarea.style.resize = "none";
            textarea.style.overflow = "hidden";
            const resizeTextarea = () => {
              textarea.style.height = 'auto';
              textarea.style.height = textarea.scrollHeight + 'px';
            };
            textarea.addEventListener('input', resizeTextarea);
            setTimeout(resizeTextarea, 0);
          });
          
          [nomeInput, efeitoInput, custoInput].forEach(inp => {
              inp.addEventListener("input", () => {
                  habilidade.nome = nomeInput.value;
                  habilidade.efeito = efeitoInput.value;
                  habilidade.custo = custoInput.value;
                  saveHabilidades();
              });
          });

          removeBtn.addEventListener("click", () => {
              habilidades = habilidades.filter(h => h !== habilidade);
              tr.remove();
              saveHabilidades();
          });

          tr.appendChild(createCell(nomeInput));
          tr.appendChild(createCell(efeitoInput));
          tr.appendChild(createCell(custoInput));
          tr.appendChild(createCell(removeBtn));
          habilidadesTable.appendChild(tr);
      }

      function renderHabilidades() {
          habilidadesTable.innerHTML = "";
          habilidades.forEach(h => criarLinhaHabilidade(h));
      }

      addHabilidadeBtn.addEventListener("click", () => {
          const novaHabilidade = { nome: '', efeito: '', custo: '' };
          habilidades.push(novaHabilidade);
          criarLinhaHabilidade(novaHabilidade);
          saveHabilidades();
      });

      function syncAll(){
          renderAttributes();
          renderSkills();
          updateMeters();
          renderInventory(); 
          renderHabilidades();
          renderBodyDiagram();
          renderDetailsAndInfo(); 
          saveState();
      }

      // --- LISTENERS DE CONTROLES (HP, SAN, ADR) ---
      document.getElementById('hpMinus').addEventListener('click',()=>{state.hpCurrent=Number(state.hpCurrent)-1;syncAll();});
      document.getElementById('hpPlus').addEventListener('click',()=>{state.hpCurrent=Number(state.hpCurrent)+1;syncAll();});
      document.getElementById('sanMinus').addEventListener('click',()=>{state.sanCurrent=Number(state.sanCurrent)-1;syncAll();});
      document.getElementById('sanPlus').addEventListener('click',()=>{state.sanCurrent=Number(state.sanCurrent)+1;syncAll();});
      document.getElementById('adrMinus').addEventListener('click',()=>{state.adrCurrent=Math.max(0,Number(state.adrCurrent)-1);syncAll();});
      document.getElementById('adrPlus').addEventListener('click',()=>{state.adrCurrent=Math.min(4,Number(state.adrCurrent)+1);syncAll();});

      // --- ALTERA√á√ÉO AQUI: Listener do Input de HP M√°ximo ---

document.getElementById('hpMax').addEventListener('change', e => {
    const con = Number(state.attrs.CON) || 0;
    const tam = Number(state.attrs.TAM) || 0;
    const hpBonus = Math.floor(con + tam) / 2;
    
    // O valor que voc√™ digitou menos o b√¥nus atual vira a nova Base
    state.hpBase = Number(e.target.value) - hpBonus;
    recalcHPandSAN();
});

// Listener para o SAN M√°ximo
document.getElementById('sanMax').addEventListener('change', e => {
    const men = Number(state.attrs.MEN) || 0;
    const sanBonus = men * 5;
    
    // O valor que voc√™ digitou menos o b√¥nus atual vira a nova Base
    state.sanBase = Number(e.target.value) - sanBonus;
    recalcHPandSAN();
});

      ['hpCurrent','sanCurrent','sanMax'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('change',e=>{
          state[id]=Number(e.target.value);
          if(id==='sanMax' && state.sanCurrent>state.sanMax) state.sanCurrent=state.sanMax;
          syncAll();
        });
      });

      const hpLabel = document.querySelector('.bar:first-child .label'); 
      const bodyDiagram = document.getElementById('body-diagram');
      
      if (hpLabel) {
          hpLabel.style.cursor = 'pointer';
          hpLabel.addEventListener('dblclick', () => {
              state.isBodyDiagramVisible = !state.isBodyDiagramVisible; 
              bodyDiagram.style.display = state.isBodyDiagramVisible ? 'flex' : 'none'; 
              saveState();
          });
      }

      const h2Bars = document.querySelector('.panel h2');
      const adrenalinaBarContainer = document.getElementById('adrenalinaBarContainer'); 

      if (h2Bars && adrenalinaBarContainer) {
          h2Bars.style.cursor = 'pointer'; 
          h2Bars.addEventListener('dblclick', (e) => {
              e.preventDefault(); 
              state.isAdrenalineVisible = !state.isAdrenalineVisible; 
              adrenalinaBarContainer.style.display = state.isAdrenalineVisible ? 'block' : 'none'; 
              saveState();
          });
      }

      const rollModal = document.getElementById('rollModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const rollResultContent = document.getElementById('rollResultContent');
      const rollSkillName = document.getElementById('rollSkillName');
      const criticalFailSound = document.getElementById('criticalFailSound'); 

      function showRollResult(skillName, resultText, rollNumber) {
        rollSkillName.textContent = `Per√≠cia: ${skillName}`;
        rollResultContent.innerHTML = `${resultText} (Rolagem: ${rollNumber})`;
        rollModal.style.display = 'block';
      }

      closeModalBtn.onclick = function() {
        rollModal.style.display = 'none';
      }

      closeModalBtn.onclick = function() {
        rollModal.style.display = 'none';
      };

function rollSkill(name){
    const val = state.skills[name] ?? SKILLS.find(s=>s[0]===name)[1] ?? 0;
    const roll = randInt(1,20);
    const th = THRESHOLDS[Math.max(1,Math.min(20,Math.floor(val)))] || {N:21,B:null,E:null};
    let outcome = {type:'Falha',detail:`Rolou ${roll} < Normal(${th.N})`};
    if(roll >= th.N) outcome = {type:'Normal',detail:`Rolou ${roll} ‚â• Normal(${th.N})`};
    if(th.B !== null && roll >= th.B) outcome = {type:'Bom',detail:`Rolou ${roll} ‚â• Bom(${th.B})`};
    if(th.E !== null && roll >= th.E) {outcome = {type:'Extremo',detail:`Rolou ${roll} ‚â• Extremo(${th.E})`};
}
    if(roll === 1) {outcome = {type:'Falha Cr√≠tica',detail:`Sinistro '-'`};
}

    const finalResult = outcome.type;
    const details = outcome.detail;
    
    let resultColor = 'var(--text)'; 
    
    switch (finalResult) { 
        case 'Falha Cr√≠tica':
            resultColor = 'var(  --critfail)';
            break;
        case 'Falha':
            resultColor = 'var(--fail)';
            break;
        case 'Normal':
            resultColor = 'var(--success)';
            break;
        case 'Bom':
            resultColor = 'var(--great)';
            break;
        case 'Extremo':
            resultColor = 'var(--extreme)';
            break;
    }
    
    const skillNameElement = document.getElementById('rollSkillName');
    skillNameElement.textContent = name.toUpperCase();
    skillNameElement.style.color = 'var(--text)';

    const rollValueElement = document.getElementById('rollValue');
    rollValueElement.textContent = roll;
    rollValueElement.style.color = resultColor;
    
    const rollResultElement = document.getElementById('rollResult');
    rollResultElement.textContent = finalResult;
    rollResultElement.style.color = resultColor; 
    
    document.getElementById('rollDetails').textContent = details;
    
    rollModal.style.display = 'block';
}

      document.querySelectorAll('.tab-btn').forEach(button => {
          button.addEventListener('click', () => {
              const targetTabId = button.dataset.tab;

              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

              button.classList.add('active');
              document.getElementById(targetTabId).classList.add('active');
          });
      });

      const detailIds = ['nomePersonagem','nomeJogador','idade','genero','ocupacao','residencia','nascimento'];
      detailIds.forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input',e=>{
            state.details[id]=e.target.value;
            if(id === 'nomePersonagem') updateSheetName();
            saveState();
        });
      });
      
      const infoIds = ['infoDescricao','infoCaracteristicas','infoIdeologia','infoFerimentos','infoPessoas','infoLocais','infoFobias','infoObjetos', 'infoDinheiro', 'infoPatrimonio'];
      infoIds.forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input',e=>{state.info[id]=e.target.value;saveState();});
      });


      createSheetBtn.addEventListener('click', createNewSheet);
      backToIndexBtn.addEventListener('click', () => {
          currentSheetId = null;
          localStorage.removeItem('cp_last_sheet_id'); 
          renderIndex();
      });

let syncInterval = null; // Vari√°vel para controlar o tempo

function enableRealtime(id) {
    console.log("Monitoramento via Intervalo ativado para:", id);

    // Se j√° houver um cron√¥metro rodando de outra ficha, a gente limpa ele
    if (syncInterval) clearInterval(syncInterval);

    // Criamos um novo cron√¥metro que roda a cada 4 segundos
    syncInterval = setInterval(async () => {
        // S√≥ busca se o usu√°rio estiver com a aba do navegador ativa
        if (document.visibilityState === 'visible' && currentSheetId === id) {
            
            const { data, error } = await _supabase
                .from('fichas')
                .select('dados')
                .eq('nome_id', id)
                .maybeSingle();

            if (data && data.dados) {
                // Comparamos se o que est√° no banco √© diferente do que est√° na tela
                const dadosNovos = JSON.stringify(data.dados);
                const dadosAtuais = JSON.stringify(state);

                if (dadosNovos !== dadosAtuais) {
                    console.log("Mudan√ßa detectada no banco! Atualizando tela...");
                    state = data.dados;
                    syncAll(); // Atualiza o HP, atributos, etc.
                }
            }
        }
    }, 4000); // 4000 milissegundos = 4 segundos
}

      function initApp() {
          const list = getSheetList();
          const lastSheetId = localStorage.getItem('cp_last_sheet_id');
          
          if (lastSheetId && list.some(s => s.id === lastSheetId)) {
              loadSheet(lastSheetId);
          } 
          else if (list.length > 0) {
              loadSheet(list[0].id);
          } 
          else {
              renderIndex(); 
          }
      }

      initApp();
    }); 
  </script>
</body>
</html>
